package co.pextra.scenarios.SensitiveProductStorage2;

import java.util.List
import co.pextra.model2.Reading
import java.lang.Double
import java.lang.Long
import java.util.Date;
import org.drools.core.time.SessionPseudoClock;

global SessionPseudoClock clock;

rule IntrinsicContextUpdate2
    no-loop
    when
        context: co.pextra.model2.Context()
        reading: co.pextra.model2.Reading(id == context.id)
    then
        context.setReading(reading);
        update(context);
    end


rule SpeedReading2
    no-loop
    when
        location: Location(bearer: bearer)
        Person(this == bearer, speed: speed)
        readings: List() from accumulate(
                r: co.pextra.model2.Reading(id == location.id) over window:time( 2m ),
                collectList(r)
        )
    then
        Reading<Double> reading = new Reading<>(Speed.computeSpeed(readings), speed.getId(), clock.getCurrentTime());
        insert(reading);
    end


rule TimeToThresholdReading2
    no-loop
    when
        temperature: Temperature(bearer: bearer)
        batch: Batch(container == bearer, ttt: ttt)
        readings: List(size > 0) from accumulate(
            r: co.pextra.model2.Reading(id == temperature.id),
            collectList(r)
        )
    then
        Reading<Long> reading = new Reading<>(
                TimeToThreshold.computeTTT(readings, batch.getProductType()),
                ttt.getId(),
                clock.getCurrentTime()
                );
        insert(reading);
    end



rule EstimateTimeOfArrivalUpdate
    no-loop
    when
        responsibility: Responsibility(responsible: responsible, batches: batches)
        person: Person( this memberOf responsible)
        Batch( this memberOf batches, container: container )
        Location(this == person.location, pl: value)
        Speed(this == person.speed, ps: value)
        Location(this == container.location, cl: value)
    then
    end